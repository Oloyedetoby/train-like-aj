<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Train Like AJ - Boxing AI Coach</title>
  
  <!-- STYLING -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FIXED PATH: Removed leading slash -->
  <link rel="stylesheet" href="./src/css/styles.css">
  
  <!-- MEDIAPIPE AI LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

  <style>
    /* Custom Styles for Overlays */
    .form-guide {
      position: absolute;
      top: 80px; right: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 16px;
      min-width: 280px; max-width: 350px;
      border: 2px solid rgba(255, 215, 0, 0.3);
      z-index: 50;
    }
    .form-tip {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      color: #fff;
      border-left: 3px solid #FFD700;
      margin-top: 5px;
    }
    .stance-indicator {
      position: absolute;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      border-radius: 24px;
      padding: 12px 24px;
      border: 2px solid rgba(255, 215, 0, 0.3);
      z-index: 50;
    }
    .stance-indicator.good { border-color: #4ECDC4; color: #4ECDC4; }
    .stance-indicator.bad { border-color: #FF6B6B; color: #FF6B6B; }
    
    /* Combo Display Text */
    #combo-display {
      text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="flex flex-col h-screen">
    
    <!-- HEADER -->
    <header class="bg-gradient-to-r from-red-600 to-red-700 p-4 flex justify-between items-center shadow-xl z-20">
      <div class="flex items-center space-x-4">
        <!-- FIXED PATH: Removed leading slash -->
        <img src="./src/assets/images/aj_logo.png" alt="AJ Logo" class="h-12 rounded-full shadow-lg border-2 border-white">
        <div>
          <h1 class="text-2xl font-bold tracking-wider italic">TRAIN LIKE AJ</h1>
          <p class="text-xs text-red-200 font-semibold">AI PERFORMANCE COACH</p>
        </div>
      </div>
      <div class="flex items-center space-x-6">
        <div class="text-right">
          <p class="text-xs text-red-200 uppercase tracking-widest">Score</p>
          <p id="score" class="text-3xl font-bold font-mono">0</p>
        </div>
        <div class="text-right">
          <p class="text-xs text-red-200 uppercase tracking-widest">Time</p>
          <p id="timer" class="text-2xl font-bold font-mono">3:00</p>
        </div>
        <button id="sound-toggle" class="bg-red-800 hover:bg-red-900 p-3 rounded-full transition-colors shadow-md" title="Toggle Sound">üîä</button>
      </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
      
      <!-- GAME AREA (CANVAS) -->
      <div class="flex-1 relative bg-black flex justify-center items-center overflow-hidden group">
        
        <!-- Loading Screen -->
        <div id="loading-container" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-50">
          <div class="loading-spinner"></div>
          <p id="loading-message" class="text-2xl mt-4 text-gray-300 font-light">Initializing Vision AI...</p>
          <p class="text-sm text-gray-500 mt-2">Please allow camera access</p>
        </div>

        <!-- The AI Vision Layer -->
        <canvas id="output" class="absolute top-0 left-0 w-full h-full object-cover"></canvas>
        <video id="video" class="hidden"></video>

        <!-- UI Overlays -->
        <div id="combo-display" class="absolute top-24 w-full text-center text-5xl font-black text-yellow-400 z-30 pointer-events-none transition-all duration-200"></div>
        
        <div id="jab-target" class="target">1</div>
        <div id="cross-target" class="target">2</div>
        <div id="combo-counter"></div>

        <div id="form-guide" class="form-guide hidden">
          <div class="form-guide-header">
            <span class="text-2xl">üìã</span>
            <span class="font-bold text-yellow-400">Technique Check</span>
          </div>
          <div id="form-guide-content" class="flex flex-col gap-2"></div>
        </div>

        <div id="stance-indicator" class="stance-indicator hidden">
          <div class="flex items-center gap-2 font-bold text-lg">
            <span>ü•ä</span> <span id="stance-text">Checking stance...</span>
          </div>
        </div>

        <div id="stats-overlay" class="absolute bottom-4 left-4 bg-black/70 backdrop-blur-sm p-4 rounded-lg text-sm space-y-1 hidden font-mono text-green-400 border border-green-900">
          <p>FPS: <span id="fps-counter">--</span></p>
          <p>Punches: <span id="total-punches">0</span></p>
          <p>Accuracy: <span id="accuracy">0%</span></p>
        </div>
      </div>

      <!-- SIDEBAR CONTROLS -->
      <aside class="w-80 bg-gray-900 p-6 space-y-6 border-l border-gray-800 overflow-y-auto custom-scrollbar shadow-2xl z-20">
        
        <!-- Live Feedback -->
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg border border-gray-700">
          <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Last Detection</h2>
          <p id="last-punch" class="text-3xl font-black text-yellow-500 text-center py-2">---</p>
          <p id="punch-confidence" class="text-center text-xs text-gray-500">Waiting for input...</p>
        </div>

        <!-- Progress Bars -->
        <div class="space-y-4">
          <div>
            <div class="flex justify-between text-xs font-bold uppercase text-gray-400 mb-1">
              <span>Speed</span>
              <span id="speed-value" class="text-yellow-400">0%</span>
            </div>
            <div class="bg-gray-800 h-2 rounded-full overflow-hidden">
              <div id="speed-bar" class="bg-yellow-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between text-xs font-bold uppercase text-gray-400 mb-1">
              <span>Technique</span>
              <span id="form-value" class="text-red-400">0%</span>
            </div>
            <div class="bg-gray-800 h-2 rounded-full overflow-hidden">
              <div id="form-bar" class="bg-red-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          <p id="feedback" class="text-center text-sm font-medium text-white italic min-h-[20px]">Ready to train!</p>
        </div>

        <!-- Session Stats -->
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg border border-gray-700">
          <div class="grid grid-cols-2 gap-4 text-center">
            <div>
              <p class="text-xs text-gray-400 uppercase">Hits</p>
              <p id="session-hits" class="text-xl font-bold text-green-400">0</p>
            </div>
            <div>
              <p class="text-xs text-gray-400 uppercase">Misses</p>
              <p id="session-misses" class="text-xl font-bold text-red-400">0</p>
            </div>
            <div>
              <p class="text-xs text-gray-400 uppercase">Streak</p>
              <p id="best-combo" class="text-xl font-bold text-yellow-400">0</p>
            </div>
            <div>
              <p class="text-xs text-gray-400 uppercase">Level</p>
              <p id="current-level" class="text-xl font-bold text-purple-400">1</p>
            </div>
          </div>
        </div>

        <!-- FORM LAB (Technique) -->
        <div class="pt-4 border-t border-gray-800">
          <label class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-2 block">üî¨ Form Laboratory</label>
          <div class="flex gap-2">
            <select id="technique-select" class="bg-gray-800 text-white text-sm rounded-lg px-3 py-2 flex-1 border border-gray-600 focus:border-yellow-500 outline-none transition-colors cursor-pointer">
              <option value="Jab">Jab</option>
              <option value="Cross">Cross</option>
              <option value="Left Hook">Left Hook</option>
              <option value="Right Hook">Right Hook</option>
              <option value="Left Uppercut">Left Uppercut</option>
              <option value="Right Uppercut">Right Uppercut</option>
            </select>
            <button id="start-technique" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-4 rounded-lg transition-colors shadow-lg shadow-yellow-500/20">
              GO
            </button>
          </div>
        </div>

        <!-- GAME MODES -->
        <div class="space-y-3 pt-4 border-t border-gray-800">
          <label class="text-xs font-bold text-gray-500 uppercase tracking-widest block">Drills</label>
          
          <button id="start-combo" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 p-3 rounded-lg font-bold shadow-lg shadow-orange-500/20 transition-all transform hover:scale-[1.02] active:scale-95 text-white flex items-center justify-center gap-2">
            <span>ü•ä</span> Combo Trainer
          </button>

          <button id="start-mitts" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 p-3 rounded-lg font-bold shadow-lg shadow-green-500/20 transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
            <span>üéØ</span> Focus Mitts
          </button>
          
          <div class="grid grid-cols-2 gap-2">
            <button id="start-timed" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-lg text-sm font-bold transition-colors border border-gray-700">
              ‚è±Ô∏è 3 Min Round
            </button>
            <button id="start-survival" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-lg text-sm font-bold transition-colors border border-gray-700">
              üíÄ Survival
            </button>
          </div>
        </div>

        <!-- UTILITIES -->
        <div class="space-y-2 pt-4 border-t border-gray-800">
          <button id="toggle-form-guide" class="w-full text-left px-3 py-2 text-xs text-gray-400 hover:text-white transition-colors flex justify-between">
            <span>Show Form Guide</span>
            <span class="text-green-400">ON</span>
          </button>
          <button id="toggle-stats" class="w-full text-left px-3 py-2 text-xs text-gray-400 hover:text-white transition-colors flex justify-between">
            <span>Performance Stats</span>
            <span>OFF</span>
          </button>
          <button id="reset-session" class="w-full text-left px-3 py-2 text-xs text-red-400 hover:text-red-300 transition-colors">
            Reset Session Data
          </button>
        </div>

        <div class="bg-gradient-to-br from-yellow-900/50 to-transparent border border-yellow-900/50 rounded-xl p-4 mt-4">
          <h3 class="font-bold mb-1 text-yellow-500 text-xs uppercase flex items-center gap-2">üí° AJ's Corner</h3>
          <p id="training-tip" class="text-xs text-yellow-200/80 leading-relaxed">Keep your guard up and snap your punches back quickly!</p>
        </div>
      </aside>
    </main>
  </div>

  <!-- MAIN LOGIC -->
  <script type="module">
    // IMPORTS - FIXED RELATIVE PATHS
    import { detectPunch, resetPunchDetection } from './src/js/punch.js';
    import { calculateScore } from './src/js/scoring.js';
    import { startTimedMode, startSurvivalMode, FocusMittDrill } from './src/js/game.js';
    import { playSound, toggleSound, FPSCounter, gameState, speakCoach } from './src/js/utils.js';
    import { TechniqueTrainer } from './src/js/technique.js';
    import { ComboDrill } from './src/js/combo.js';

    // DOM ELEMENTS
    const videoElement = document.getElementById('video');
    const canvasElement = document.getElementById('output');
    const canvasCtx = canvasElement.getContext('2d');
    const scoreElement = document.getElementById('score');
    const punchElement = document.getElementById('last-punch');
    const speedBar = document.getElementById('speed-bar');
    const formBar = document.getElementById('form-bar');
    const feedbackElement = document.getElementById('feedback');
    const timerElement = document.getElementById('timer');
    const errorMessage = document.getElementById('error-message');
    const loadingContainer = document.getElementById('loading-container');
    const jabTarget = document.getElementById('jab-target');
    const crossTarget = document.getElementById('cross-target');
    const statsOverlay = document.getElementById('stats-overlay');
    const fpsCounter = new FPSCounter();
    
    // GAME STATE
    let mode = 'game'; // 'game' or 'technique'
    let totalScore = 0;
    let activeDrill = null; // Can be FocusMittDrill OR ComboDrill
    let sessionStats = { hits: 0, misses: 0, totalPunches: 0 };
    let isGameReady = false; // Warmup flag

    // TRAINERS
    const techniqueTrainer = new TechniqueTrainer(canvasCtx);
    const formGuide = new FormGuideSystem();

    // TIPS SYSTEM
    const tips = [
      "Keep your guard up and snap your punches back quickly!",
      "Rotate your hips for maximum power in your cross!",
      "A good jab sets up everything - master it first!",
      "Breathe out sharply with each punch!",
      "Keep your shoulders relaxed and chin tucked!",
      "Pivot your back foot when throwing the cross!",
      "Speed comes from relaxation, not tension!",
    ];
    setInterval(() => {
      const idx = Math.floor(Math.random() * tips.length);
      document.getElementById('training-tip').textContent = tips[idx];
    }, 15000);

    // --- FORM GUIDE CLASS ---
    function FormGuideSystem() {
      const el = document.getElementById('form-guide');
      const content = document.getElementById('form-guide-content');
      const stanceEl = document.getElementById('stance-indicator');
      let enabled = true;

      return {
        toggle: () => {
          enabled = !enabled;
          if (!enabled) { el.classList.add('hidden'); stanceEl.classList.add('hidden'); }
          return enabled;
        },
        update: (punchData) => {
          if (!enabled) return;
          // Stance
          if (punchData.extras?.stance) {
             const s = punchData.extras.stance;
             stanceEl.classList.remove('hidden');
             stanceEl.className = `stance-indicator ${s.isGood ? 'good' : 'bad'}`;
             document.getElementById('stance-text').textContent = s.isGood ? "Good Stance!" : (s.tips[0] || "Adjust Stance");
          }
          // Tips
          if (punchData.formTip) {
             el.classList.remove('hidden');
             const div = document.createElement('div');
             div.className = 'form-tip';
             div.innerHTML = `<strong>${punchData.punch}:</strong> ${punchData.formTip}`;
             content.innerHTML = ''; // Clear old
             content.appendChild(div);
             setTimeout(() => div.remove(), 2500);
          }
        }
      };
    }

    // --- MAIN GAME LOOP ---
    function onResults(results) {
      // Hide loader once
      if (!loadingContainer.classList.contains('hidden')) loadingContainer.classList.add('hidden');

      // Update FPS
      fpsCounter.update();
      document.getElementById('fps-counter').textContent = fpsCounter.getFPS();

      // Setup Canvas
      canvasElement.width = results.image.width;
      canvasElement.height = results.image.height;
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      // MIRROR FLIP
      canvasCtx.translate(canvasElement.width, 0);
      canvasCtx.scale(-1, 1);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      
      if (results.poseLandmarks) {
        
        // 1. WARMUP CHECK
        if (!isGameReady) {
          // Just draw skeleton, no detection
          window.drawConnectors(canvasCtx, results.poseLandmarks, window.POSE_CONNECTIONS, { color: 'rgba(255, 255, 255, 0.1)', lineWidth: 1 });
          canvasCtx.restore();
          return;
        }

        // 2. TECHNIQUE MODE
        if (mode === 'technique') {
          techniqueTrainer.analyze(results.poseLandmarks, canvasElement.width, canvasElement.height);
          // Draw subtle skeleton for self-awareness
          window.drawConnectors(canvasCtx, results.poseLandmarks, window.POSE_CONNECTIONS, { color: 'rgba(255, 255, 255, 0.1)', lineWidth: 1 });
        } 
        
        // 3. GAME MODES (Combo, Mitts, etc)
        else {
          detectPunch(results.poseLandmarks, canvasElement.width, canvasElement.height).then(punchData => {
            if (punchData && punchData.punch) {
              // Valid Punch Detected
              playSound('punch', { volume: 0.3 });
              
              // Update Stats
              sessionStats.totalPunches++;
              gameState.increment('totalPunches');
              updateSessionUI();
              
              // Update UI Bars
              const punchType = punchData.punch.toLowerCase().split(' ')[0];
              const speed = punchType === 'cross' || punchType === 'right' ? punchData.extras.rightSpeed : punchData.extras.leftSpeed;
              const angle = punchType === 'cross' || punchType === 'right' ? punchData.extras.rightAngle : punchData.extras.leftAngle;
              const scores = calculateScore({ punchType, speed, angle });
              
              updatePunchUI(punchData, scores);
              formGuide.update(punchData);

              // ** Send to Active Drill **
              if (activeDrill && activeDrill.isRunning) {
                activeDrill.checkPunch(punchData.punch, scores);
              }

            } else {
              // No punch, but maybe update stance check
              formGuide.update(punchData);
            }
          });
          
          // Draw Body Tracking
          window.drawConnectors(canvasCtx, results.poseLandmarks, window.POSE_CONNECTIONS, { color: 'rgba(0, 255, 0, 0.4)', lineWidth: 2 });
          window.drawLandmarks(canvasCtx, results.poseLandmarks, { color: 'rgba(255, 0, 0, 0.6)', lineWidth: 1, radius: 2 });
        }
      }
      canvasCtx.restore();
    }

    // --- UI HELPERS ---
    function updateSessionUI() {
      document.getElementById('session-hits').textContent = sessionStats.hits;
      document.getElementById('session-misses').textContent = sessionStats.misses;
      document.getElementById('total-punches').textContent = sessionStats.totalPunches;
      const acc = sessionStats.totalPunches > 0 ? ((sessionStats.hits / sessionStats.totalPunches) * 100).toFixed(0) : 0;
      document.getElementById('accuracy').textContent = acc + '%';
    }

    function updatePunchUI(data, scores) {
      punchElement.textContent = data.punch.toUpperCase();
      document.getElementById('punch-confidence').textContent = `${Math.round(data.confidence)}% conf`;
      speedBar.style.width = `${scores.speedScore}%`;
      formBar.style.width = `${scores.formScore}%`;
      document.getElementById('speed-value').textContent = `${Math.round(scores.speedScore)}%`;
      document.getElementById('form-value').textContent = `${Math.round(scores.formScore)}%`;
    }

    function updateScore(points) {
      totalScore += points;
      scoreElement.textContent = totalScore;
      scoreElement.classList.add('scale-125', 'text-yellow-300'); // simple pulse class
      setTimeout(() => scoreElement.classList.remove('scale-125', 'text-yellow-300'), 200);
    }

    // --- BUTTON HANDLERS ---
    
    function stopAllDrills() {
      if (activeDrill && activeDrill.isRunning) activeDrill.stop();
      techniqueTrainer.stop();
      
      // Reset Targets
      jabTarget.style.display = 'none';
      crossTarget.style.display = 'none';
      document.getElementById('combo-display').textContent = '';
    }

    function resetGameUI() {
      stopAllDrills();
      jabTarget.style.display = 'flex';
      crossTarget.style.display = 'flex';
      totalScore = 0;
      scoreElement.textContent = '0';
      resetPunchDetection();
    }

    // 1. Technique Lab
    document.getElementById('start-technique').addEventListener('click', () => {
      mode = 'technique';
      stopAllDrills();
      feedbackElement.textContent = "Entering Form Lab...";
      const move = document.getElementById('technique-select').value;
      techniqueTrainer.start(move);
    });

    // 2. Combo Trainer
    document.getElementById('start-combo').addEventListener('click', () => {
      mode = 'game';
      resetGameUI();
      const ui = { jabTarget, crossTarget };
      activeDrill = new ComboDrill(ui, updateScore);
      activeDrill.start();
      document.getElementById('start-combo').innerHTML = '‚èπÔ∏è Stop Combo';
    });

    // 3. Focus Mitts
    document.getElementById('start-mitts').addEventListener('click', () => {
      mode = 'game';
      resetGameUI();
      const ui = { jabTarget, crossTarget };
      activeDrill = new FocusMittDrill(ui, updateScore);
      activeDrill.start();
      document.getElementById('start-mitts').innerHTML = '‚èπÔ∏è Stop Drill';
    });

    // 4. Timed Mode
    document.getElementById('start-timed').addEventListener('click', () => {
      mode = 'game';
      resetGameUI();
      startTimedMode(timerElement);
      const ui = { jabTarget, crossTarget };
      activeDrill = new FocusMittDrill(ui, updateScore);
      activeDrill.start();
      
      // Override timer end
      const interval = setInterval(() => {
        if(timerElement.textContent === '0:00') {
          activeDrill.stop();
          clearInterval(interval);
          playSound('combo');
          alert(`Round Over! Score: ${totalScore}`);
        }
      }, 1000);
    });

    // 5. Survival Mode
    document.getElementById('start-survival').addEventListener('click', () => {
      mode = 'game';
      resetGameUI();
      startSurvivalMode(timerElement);
      const ui = { jabTarget, crossTarget };
      activeDrill = new FocusMittDrill(ui, updateScore);
      activeDrill.start();

      const check = setInterval(() => {
        if (!activeDrill || !activeDrill.isRunning) { clearInterval(check); return; }
        if (activeDrill.totalMisses >= 3) {
          activeDrill.stop();
          clearInterval(check);
          playSound('miss');
          alert(`GAME OVER! Score: ${totalScore}`);
        }
      }, 500);
    });

    // Toggles
    document.getElementById('sound-toggle').addEventListener('click', (e) => {
      const on = toggleSound();
      e.target.textContent = on ? 'üîä' : 'üîá';
    });
    document.getElementById('toggle-stats').addEventListener('click', () => {
      statsOverlay.classList.toggle('hidden');
    });
    document.getElementById('toggle-form-guide').addEventListener('click', (e) => {
      const on = formGuide.toggle();
      e.target.querySelector('span:last-child').textContent = on ? 'ON' : 'OFF';
      e.target.querySelector('span:last-child').className = on ? 'text-green-400' : 'text-red-400';
    });
    document.getElementById('reset-session').addEventListener('click', () => {
      if(confirm("Clear stats?")) {
        sessionStats = { hits: 0, misses: 0, totalPunches: 0 };
        updateSessionUI();
        totalScore = 0;
        scoreElement.textContent = '0';
      }
    });

    // INIT
    async function main() {
      try {
        const pose = new window.Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
        pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);
        
        const camera = new window.Camera(videoElement, { onFrame: async () => { await pose.send({ image: videoElement }); }, width: 1280, height: 720 });
        await camera.start();
        
        // Warmup
        setTimeout(() => {
          isGameReady = true;
          playSound('start');
          speakCoach("System Ready. Let's work.");
          console.log("ü•ä Detection Active");
        }, 4000);
      } catch(e) {
        errorMessage.classList.remove('hidden');
        errorMessage.querySelector('p:last-child').textContent = "Camera Error: " + e.message;
      }
    }
    document.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>